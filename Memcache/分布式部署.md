# 分布式部署

##1.普通Hash分布
通过md5把key处理成一个32位的字符串，取前前8位。再经过Hash算法处理成一个整数并返回，然后映射到一台Memcache服务器上。

```php
function mHash($key){
    $hash = substr(md5($key), 0, 8);
    $seed = 31;
    $hash = 0;
    
    for($i = 0; $i < 8; $i++){
        $hash = $hash * $seed + ord($hash{$i});
        $i ++;
    }
    return $hash & 0x7FFFFFFF;
}

// 使用
// memcahce配置
$server = array(
    array(),
    array(),
);

$key = 'key';
$value = 'value';
$sc = $server[mHash($key)%2];   // 对服务器数量取模

$memcached = new Memcached($sc);
$memcached->set($key, $value);
```

##2.一致性Hash分布
Consistent Hashing
如果在服务器数量可能改变的情况下，使用普通的Hash分布，会导致带服务器数量改变前后，同一个key被分配到不同的服务器上，这样会导致之前的数据丢失。

一致性Hash分布的步骤：
>* 将key经过一次Hash计算得出一个整数值；
>* 将服务器的key也经过一次Hash计算得出一个整数值；
>* key的存取时，顺着一个方向（大于或小于），找到距离最近的服务器保存；
当服务器数量改变时，该台服务器的key会重新寻找最近的服务器，丢失的只是比较少的数据。

实现，创建一个类来管理服务器和key的配对，该类拥有两个属性：
>* serverList：保存服务器列表；
>* isSorted：记录服务器列表是否排过序/是否改变；
同时，该类拥有下面三个方法：
>* addServer：添加服务器；
>* removeServer：删除服务器；
>* lookUp：为一个key寻找服务器

```php
class FlexiHash
{
    private $serverList = array();
    private $isSorted = FALSE;
    
    function addServer($server){
        
    }
    
    function removeServer($server){
    
    }
    
    function lookUp($key){
    
    }

}

```

