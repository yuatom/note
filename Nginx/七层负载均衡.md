# 七层负载均衡
>* 二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；
>* 三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；
>* 四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器；
>* 七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。

##策略
1、轮询（默认）
每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。
2、weight
指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。
2、ip_hash
每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。
3、fair（第三方）
按后端服务器的响应时间来分配请求，响应时间短的优先分配。
4、url_hash（第三方）
按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。

##Session问题
>* Session或凭据缓存到独立的服务器，会增加Session服务器的负担；
>* Session或凭据保存数据库中，会增加数据库的负担；
>* nginx ip_hash 保持同一IP的请求都是指定到固定的一台服务器，该种方式比较轻量、方便。

##反向代理
基本设置

```
location / {
    #设置主机头和客户端真实地址，以便服务器获取客户端真实IP
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
    #禁用缓存
    proxy_buffering off;
 
    #设置反向代理的地址
    proxy_pass http://192.168.1.1;       
}

```

##负载均衡
基本设置

```
upstream backend {
    #ip_hash;
 
    server 192.168.1.251;
    server 192.168.1.252;
    server 192.168.1.247;
}
```




