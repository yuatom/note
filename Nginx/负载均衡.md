# 负载均衡
## 负载均衡概念
>* 二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；
>* 三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；
>* 四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器；
>* 七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。

## 策略
* 轮询（round-robin）
默认，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除；

* weight
指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况；

* ip_hash
每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题；

* 最少连接（least-connected）
根据活跃的链接数量来决定下一个请求的分发；

* fair（第三方）
按后端服务器的响应时间来分配请求，响应时间短的优先分配；

* url_hash（第三方）
按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效；


## Session一致性
轮询/权重/最少连接等均衡策略可能使同一个客户端的请求发送不同的服务器上，导致会话信息不一致。
可通过以下方式使得多个服务器之间共享会话信息，但是效率较低：
>* Session或凭据缓存到独立的服务器，会增加Session服务器的负担；
>* Session或凭据保存数据库中，会增加数据库的负担；

### ip_hash
策略能够保持同一IP的请求都是指定到固定的一台服务器，该种方式比较轻量、方便，但是不能够真正地做到“均衡”。

### nginx-sticky-module
该模块通过在cookie中嵌入路由信息，来使同一个客户端的请求落在同一台服务器上。



##反向代理
基本设置

```
location / {
    #设置主机头和客户端真实地址，以便服务器获取客户端真实IP
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
    #禁用缓存
    proxy_buffering off;
 
    #设置反向代理的地址
    proxy_pass http://192.168.1.1;       
}

```

##负载均衡
基本设置

```
upstream backend {
    #ip_hash;
 
    server 192.168.1.251;
    server 192.168.1.252;
    server 192.168.1.247;
}
```




