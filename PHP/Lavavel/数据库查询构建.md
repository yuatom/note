# # 数据库查询构建
##获取结果集

```php
// 获取表中所有的数据
$users = DB::table('users')->get();

// 获取一条记录
$user = DB::table('users')->where('name', 'John')->first();

// 获取一个字段
$email = DB::table('users')->where('name', 'John')->value('email');

// 获取有限条记录，并回调处理
DB::table('users')->chunk(100, function($users) {
    foreach ($users as $user) {
        //
    }
});

// return false表示不处理
DB::table('users')->chunk(100, function($users) {
    // 处理结果集...
    return false;
});

// 获取所有记录中某些字段的值列表
$titles = DB::table('roles')->lists('title');
foreach ($titles as $title) {
    echo $title;
}

$roles = DB::table('roles')->lists('title', 'name');
foreach ($roles as $name => $title) {
    echo $title;
}

// 聚合
$users = DB::table('users')->count();
$price = DB::table('orders')->max('price');
当然，你可以联合其它查询子句和聚合函数来构建查询：

// select和聚合
$price = DB::table('orders')
                ->where('finalized', 1)
                ->avg('price');
```

##select子句

```php
// select某些字段
$users = DB::table('users')->select('name', 'email as user_email')->get();

// distinct结果集
$users = DB::table('users')->distinct()->get();

// 追加select字段
$query = DB::table('users')->select('name');
$users = $query->addSelect('age')->get();	// 在上面返回的sql语句中追加一个age字段

// 原生select参数，用DB::raw生成
$users = DB::table('users')
                     ->select(DB::raw('count(*) as user_count, status'))
                     ->where('status', '<>', 1)
                     ->groupBy('status')
                     ->get();

```

##where子句
`where`方法需要三个参数，第一个是字段名，第二个是数据库支持的操作符，第三个是条件的值。

```php
$users = DB::table('users')->where('votes', '=', 100)->get();
$users = DB::table('users')->where('votes', 100)->get();
$users = DB::table('users')->where('votes', '>=', 100)->get();
$users = DB::table('users')->where('votes', '<>', 100)->get();
$users = DB::table('users')->where('name', 'like', 'T%')->get();

// or
$users = DB::table('users')->where('votes', '>', 100)->orWhere('name', 'John')->get();

// between
$users = DB::table('users')->whereBetween('votes', [1, 100])->get();

// not between             
$users = DB::table('users')->whereNotBetween('votes', [1, 100])->get();

// in
$users = DB::table('users')->whereIn('id', [1, 2, 3])->get();

// not in                   
$users = DB::table('users')->whereNotIn('id', [1, 2, 3])->get();

// null                   
$users = DB::table('users')->whereNull('updated_@')->get();

// not null                   
$users = DB::table('users')->whereNotNull('updated_@')->get();
                    
// 嵌套
// select * from users where name = 'John' or (votes > 100 and title <> 'Admin')
DB::table('users')
            ->where('name', '=', 'John')
            ->orWhere(function ($query) {	// 此处回调嵌套在or里面
                $query->where('votes', '>', 100)
                      ->where('title', '<>', 'Admin');
            })
            ->get();

// select * from users 
//		where exists (
//			select 1 from orders where orders.user_id = users.id
//	)
DB::table('users')
            ->whereExists(function ($query) {
                $query->select(DB::raw(1))
                      ->from('orders')
                      ->whereRaw('orders.user_id = users.id');
            })
            ->get();
```

##排序、分组、限定

```php
$users = DB::table('users')->orderBy('name', 'desc')->get();

// group by / having          
$users = DB::table('users')->groupBy('account_id')->having('account_id', '>', 100)->get();

// having 原生              
$users = DB::table('orders')->select('department', DB::raw('SUM(price) as total_sales'))->groupBy('department')->havingRaw('SUM(price) > 2500')->get();

// limit             
$users = DB::table('users')->skip(10)->take(5)->get();
```

##insert

```php
// insert 一条
DB::table('users')->insert(
    ['email' => 'john@example.com', 'votes' => 0]);

// insert 多条
DB::table('users')->insert([
    ['email' => 'taylor@example.com', 'votes' => 0],
    ['email' => 'dayle@example.com', 'votes' => 0]
]);

// 获取自增id，insertGetId方法
$id = DB::table('users')->insertGetId(
    ['email' => 'john@example.com', 'votes' => 0]
);
```

##update

```php
DB::table('users')->where('id', 1)->update(['votes' => 1]);
            
// 快速增减
DB::table('users')->increment('votes');
DB::table('users')->increment('votes', 5);
DB::table('users')->decrement('votes');
DB::table('users')->decrement('votes', 5);

// 增减的同时修改其他字段
DB::table('users')->increment('votes', 1, ['name' => 'John']);
```

##delete

```php
// 删除所有
DB::table('users')->delete();

// 部分记录
DB::table('users')->where('votes', '<', 100)->delete();

// 删除整张表，重置自增id
DB::table('users')->truncate();
```

##连表

```php
// 内连接
$users = DB::table('users')
            ->join('contacts', 'users.id', '=', 'contacts.user_id')
            ->join('orders', 'users.id', '=', 'orders.user_id')
            ->select('users.*', 'contacts.phone', 'orders.price')
            ->get();
            
//左连接
$users = DB::table('users')
            ->leftJoin('posts', 'users.id', '=', 'posts.user_id')
            ->get();

// 扩展条件
DB::table('users')
        ->join('contacts', function ($join) {
            $join->on('users.id', '=', 'contacts.user_id')->orOn(...);
        })
        ->get();

DB::table('users')
        ->join('contacts', function ($join) {
            $join->on('users.id', '=', 'contacts.user_id')
                 ->where('contacts.user_id', '>', 5);
        })
        ->get();
```

##联合查询
连接两个查询结果

```php
$first = DB::table('users')
            ->whereNull('first_name');

$users = DB::table('users')
            ->whereNull('last_name')
            ->union($first)
            ->get();
```

