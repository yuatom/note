# 数据库迁移
##生成迁移
使用 Artisan 命令`make:migration`来创建一个新的迁移：

```shell
php artisan make:migration create_users_table
```
执行后会在database/migrations下产生迁移类文件，每个迁移文件名都包含时间戳从而允许 Laravel 判断其顺序。
使用--table和--create指定表名及该迁移是否创建一个新的数据表：

```shell
# 指定在users表中修改
php artisan make:migration add_votes_to_users_table --table=users
# 指定创建的表名
php artisan make:migration create_users_table --create=users
```

##迁移结构
生成的迁移类里有两个方法，`up`和`down`。`up`用于新增表/字段/索引，`down`方法里的操作和`up`的相反。

```php
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateFlightsTable extends Migration{
    /**
     * 运行迁移
     *
     * @return void
     */
    public function up()
    {
        Schema::create('flights', function (Blueprint $table) {
            $table->increments('id');
            $table->string('name');
            $table->string('airline');
            $table->timestamps();
        });
    }

    /**
     * 撤销迁移
     *
     * @return void
     */
    public function down()
    {
        Schema::drop('flights');
    }
}
```

##运行迁移
在Homestead环境中，在虚拟机里运行

```shell
php artisan migrate
# 如果出现“class not found”的错误提示，尝试运行以下命令后再次运行迁移
composer dump-autoload
```
回滚上一次迁移操作

```shell
php artisan migrate:rollback
```

回滚所有迁移

```shell
php artisan migrate:reset
```

先回滚再执行迁移，该命令会先回滚所有数据迁移，然后再执行当前的迁移

```shell
php artisan migrate:refresh
```

##编写迁移
###创建表
使用`Schema` facade中的`create`方法来创建数据表。
`create`方法接收两个参数，第一个参数是表名，第二个是获取用于定义新表的Blueprint对象的闭包。

```php
Schema::create('users', function ($table) {
    $table->increments('id');
});

// 检查表是否存在
if (Schema::hasTable('users')) {
    //
}

// 检查字段是否存在
if (Schema::hasColumn('users', 'email')) {
    //
}

// 选择某个数据库连接然后创建
Schema::connection('foo')->create('users', function ($table) {
    $table->increments('id');
});

// 选择存储引擎
Schema::create('users', function ($table) {
    $table->engine = 'InnoDB';
    $table->increments('id');
});
```

###重命名/删除

```php
// 重命名
Schema::rename($from, $to);

// 删除
Schema::drop('users');
Schema::dropIfExists('users');
```

###创建字段
使用`Schema` facade的table属性来创建字段：

```php
Schema::table('users', function ($table) {
    $table->string('email');
});
```

####table属性的方法

| 命令 |	描述 |
| --- | --- |
| $table->bigIncrements('id');	| 自增ID，类型为bigint| 
| $table->bigInteger('votes');	| 等同于数据库中的BIGINT类型| 
| $table->binary('data');	| 等同于数据库中的BLOB类型| 
| $table->boolean('confirmed');	| 等同于数据库中的BOOLEAN类型| 
| $table->char('name', 4);| 	等同于数据库中的CHAR类型| 
| $table->date('created_@');	| 等同于数据库中的DATE类型| 
| $table->dateTime('created_@');	| 等同于数据库中的DATETIME类型| 
| $table->decimal('amount', 5, 2);| 	等同于数据库中的DECIMAL类型，带一个精度和范围| 
| $table->double('column', 15, 8);| 	等同于数据库中的DOUBLE类型，带精度, 总共15位数字，小数点后8位.| 
| $table->enum('choices', ['foo', 'bar']);| 	等同于数据库中的 ENUM类型| 
| $table->float('amount');	| 等同于数据库中的 FLOAT 类型| 
| $table->increments('id');	| 数据库主键自增ID| 
| $table->integer('votes');	| 等同于数据库中的 INTEGER 类型| 
| $table->json('options');	| 等同于数据库中的 JSON 类型| 
| $table->jsonb('options');	| 等同于数据库中的 JSONB 类型| 
| $table->longText('description');| 	等同于数据库中的 LONGTEXT 类型| 
| $table->mediumInteger('numbers');| 	等同于数据库中的 MEDIUMINT类型| 
| $table->mediumText('description');| 	等同于数据库中的 MEDIUMTEXT类型| 
| $table->morphs('taggable');	| 添加一个 INTEGER类型的 taggable_id 列和一个 STRING类型的 taggable_type列| 
| $table->nullableTimestamps();	| 和 timestamps()一样但允许 NULL值.| 
| $table->rememberToken();	| 添加一个 remember_token 列： VARCHAR(100) NULL.| 
| $table->smallInteger('votes');| 	等同于数据库中的 SMALLINT 类型| 
| $table->softDeletes();	| 新增一个 deleted_@ 列 用于软删除.| 
| $table->string('email');| 	等同于数据库中的 VARCHAR 列  .| 
| $table->string('name', 100);	| 等同于数据库中的 VARCHAR，带一个长度| 
| $table->text('description');	| 等同于数据库中的 TEXT 类型| 
| $table->time('sunrise');	| 等同于数据库中的 TIME类型| 
| $table->tinyInteger('numbers');| 	等同于数据库中的 TINYINT 类型| 
| $table->timestamp('added_on');	| 等同于数据库中的 TIMESTAMP 类型| 
| $table->timestamps();	| 添加 created_@ 和 updated_at列.| 
| $table->uuid('id');	| 等同于数据库的UUID| 

###字段修改
用于设置字段的位置/默认值等

```php
Schema::table('users', function ($table) {
    $table->string('email')->nullable();
});
```
####部分列修改器，不包括索引修改

| 修改器	| 描述| 
| ---| ---| 
| ->first()	| 将该列置为表中第一个列 (仅适用于MySQL)| 
| ->after('column')	| 将该列置于另一个列之后 (仅适用于MySQL)| 
| ->nullable()	| 允许该列的值为NULL| 
| ->default($value)	| 指定列的默认值| 
| ->unsigned()	| 设置 integer 列为 UNSIGNED| 

####修改列
>先决条件
在修改列之前，确保已经将`doctrine/dbal`依赖添加到`composer.json`文件，Doctrine DBAL 库用于判断列的当前状态并在需要时创建SQL查询来对列进行指定的调整。

#####修改属性
`change`方法可用于修改字段的类型或属性

```php
// 修改长度
Schema::table('users', function ($table) {
    $table->string('name', 50)->change();
});
// 修改可否为null
Schema::table('users', function ($table) {
    $table->string('name', 50)->nullable()->change();
});
```

#####重命名

```php
Schema::table('users', function ($table) {
    $table->renameColumn('from', 'to');
});
```

####删除字段

```php
// 删除一个字段
Schema::table('users', function ($table) {
    $table->dropColumn('votes');
});

// 删除多个字段
Schema::table('users', function ($table) {
    $table->dropColumn(['votes', 'avatar', 'location']);
});
```

###索引

```php
// 创建字段的时候定义索引
$table->string('email')->unique();

// 创建字段后再定义索引
$table->unique('email');

// 传递字段名来创建索引，index第一个参数传递数组创建多个索引
$table->index(['account_id', 'created_@']);

// index第二参数来传递索引名，不传递时Laravel会自动生成名称
$table->index('email', 'my_index_name');
```
####索引类型
|命令	|描述|
|---|---|
|$table->primary('id');	|添加主键索引|
|$table->primary(['first', 'last']);	|添加混合索引|
|$table->unique('email');	|添加唯一索引|
|$table->unique('state', 'my_index_name');	|指定自定义索引名称
|$table->index('state');	|添加普通索引|
####删除索引
|命令	|描述|
|---|---|
|$table->dropPrimary('users_id_primary');|	从 “users”表中删除主键索引|
|$table->dropUnique('users_email_unique');|	从 “users”表中删除唯一索引|
|$table->dropIndex('geo_state_index');|	从 “geo”表中删除普通索引|

