# 中间件
##创建
使用Artisan命令make:middleware

```shell
php artisan make:middleware OldMiddleware
```
命令执行后将在app/Http/Middleware 目录内置立一个名称为 OldMiddleware 的类。中间件的示例如下：
只有age大于等于200的才会执行接下去的操作，否则会重定向到命名为home的URL中。
调用带有 **$request** 的 **$next** 方法，即可将请求传递到更深层的应用程序(允许跳过中间件) HTTP 请求在实际碰触到应用程序之前，最好是可以层层通过许多中间件，每一层都可以对请求进行检查，甚至是完全拒绝请求。

```php
<?php namespace App\Http\Middleware;

use Closure;

class OldMiddleware {

    /**
     * Run the request filter.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle($request, Closure $next){
        if ($request->input('age') < 200){
            return redirect('home');
        }
        return $next($request);
    }
}
```

##Before / After 中间件
###前置中间件
在执行请求之前执行一些操作

```php
<?php namespace App\Http\Middleware;

use Closure;

class BeforeMiddleware implements Middleware {

    public function handle($request, Closure $next)
    {
        // Perform action

        return $next($request);
    }
}
```

###后置中间件
在执行请求之后执行一些操作

```php
<?php namespace App\Http\Middleware;

use Closure;

class AfterMiddleware implements Middleware {

    public function handle($request, Closure $next)
    {
        $response = $next($request);

        // Perform action

        return $response;
    }
}
```

##注册中间件
###全局中间件
若是希望中间件被所有的 HTTP 请求给执行，只要将中间件的类加入到 app/Http/Kernel.php 的 $middleware 属性清单列表中。

###指定路由
先将中间件在 app/Http/Kernel.php 配置一个键值：

```php
// 默认的中间件
/**
     * The application's route middleware.
     *
     * These middleware may be assigned to groups or used individually.
     *
     * @var array
     */
    protected $routeMiddleware = [
        'auth' => \App\Http\Middleware\Authenticate::class,
        'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
        'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
    ];
```
 中间件一旦在 HTTP kernel 文件内被定义，你即可在路由选项内使用 middleware 键值来指派

```php
Route::get('admin/profile', ['middleware' => 'auth', function(){
    //
}]);
```

##可终止中间件
在程序将HTTP请求发送给客户端后才执行的操作。例如，Laravel 内置的 「session」 中间件，保存 session 数据是在响应已被发送到用户端 之后 才执行。
TerminableMiddleware 定义一个 terminate 方法。这个方法接收请求和响应。一旦定义了 terminable 中间件，你**需要将它增加到 HTTP kernel 文件的全局中间件清单列表中**。

```php
use Closure;
use Illuminate\Contracts\Routing\TerminableMiddleware;

class StartSession implements TerminableMiddleware {

    public function handle($request, Closure $next) {
        return $next($request);
    }

    public function terminate($request, $response) {
        // Store the session data...
    }

}
```

