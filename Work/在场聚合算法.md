# 在场用户聚合算法.md

##思路：

存：根据经纬度将地图看做是一个坐标系，不同的缩放比例对应不同的坐标单位。在用户上传位置的时候，根据经纬度计算该位置对应到的缩放比例在坐标系中的格子，将缩放比例和坐标存到数据库中。以缩放比例作为key，缩放比例和坐标拼起来作为value。同一个格子内的点的key和value均相同。

查：根据坐标查一定范围内，以指定的缩放比例的key作为groupby的字段，计算各个格子里面的点的数量。

##实现：
####1.坐标单位大小：
根据不同的缩放比例，计算坐标单位的大小（单位：m），比如缩放比例为0时对应的格子大小是20x20，缩放比例为1时是50x50。

####2.经纬度转坐标单位：
根据经纬度和距离的转换比例，100米=0.0009纬度= 0.0009788经度，将米转换为经纬度，即用经纬度来表示每个格子的大小，以缩放比例0为例子:
longitude/20x比例，latitude/20x比例（经纬度有正负，可在原经纬度的基础上加上90/180。
**例如：longitude=113.2812720，latitude= 23.11019**
在缩放等级为0的情况下，每个聚合的网格大小为20x20；
在缩放等级为1的情况下，每个聚合的网格大小为50x50；
在缩放等级为2的情况下，每个聚合的网格大小为100x100；
在缩放等级为3的情况下，每个聚合的网格大小为200x200。
**由以上计算方法得出：**
"grid_zoom_level_0" : "0_628389_1498167",
"grid_zoom_level_1" : "1_251355_599267",
"grid_zoom_level_2" : "2_125677_299633",
"grid_zoom_level_3" : "3_62838_149816",

**聚合索引：**
根据上面得出结果，与缩放比例拼成一个字符串，用于聚合查询。
假设结果为x,y，以grid_zoom_level_0为key，那么对应的value为0_x_y。
。

####3.查询聚合列表
mongodb:
```javascript
db.collection.group({
  condition:{
    "coordinate":{
      "$near":{
        "$geometry":{
          "type":"Point",
          "coordinates":[longitude,latitude]
          }
        "$maxDistance":
        }
      }
    },
  "key":{"grid_zoom_level_0":true},
  "initial":{"count":0},  //count，这个网格里的点数
  "$reduce":function(doc,prev){
    prev.count+=1;
  }
})
```

####4.查询某个聚合内的点
根据聚合索引查出即可。





